{% extends base_template|default:'shop/base_dashboard.html' %}

{% block title %}Dashboard - FashionStore{% endblock %}

{% block content %}
<div class="dashboard-content">
    <!-- Header -->
    <div class="dashboard-header">
        <h1>
            {% if user.role == 'boss' %}
                üèÜ –ü–∞–Ω–µ–ª—å —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è
            {% elif user.role == 'manager' %}
                üéØ –ü–∞–Ω–µ–ª—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞
            {% else %}
                üìä Dashboard
            {% endif %}
        </h1>
        <div class="header-actions">
            <div class="search-box">
                <input type="text" placeholder="–ü–æ–∏—Å–∫..." class="search-input">
                <i class="search-icon">üîç</i>
            </div>
            <div class="notifications">
                <span class="notification-icon">üîî</span>
                <span class="notification-badge">{{ recent_orders_count }}</span>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card revenue">
            <div class="stat-icon">üí∞</div>
            <div class="stat-content">
                <div class="stat-label">–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</div>
                <div class="stat-value">{{ total_revenue|floatformat:0 }} ‚ÇΩ</div>
                <div class="stat-change {% if revenue_growth > 0 %}positive{% elif revenue_growth < 0 %}negative{% else %}neutral{% endif %}">
                    <span class="change-icon">
                        {% if revenue_growth > 0 %}‚Üó{% elif revenue_growth < 0 %}‚Üò{% else %}‚Üí{% endif %}
                    </span>
                    {% if revenue_growth != 0 %}{{ revenue_growth }}%{% else %}–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π{% endif %} –∑–∞ –º–µ—Å—è—Ü
                </div>
            </div>
        </div>

        <div class="stat-card customers">
            <div class="stat-icon">üë•</div>
            <div class="stat-content">
                <div class="stat-label">–ü–æ–∫—É–ø–∞—Ç–µ–ª–∏</div>
                <div class="stat-value">{{ total_customers }}</div>
                <div class="stat-change neutral">
                    <span class="change-icon">üë§</span>
                    –í—Å–µ–≥–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ
                </div>
            </div>
        </div>

        <div class="stat-card sales">
            <div class="stat-icon">üìä</div>
            <div class="stat-content">
                <div class="stat-label">–ó–∞–∫–∞–∑—ã</div>
                <div class="stat-value">{{ total_orders }}</div>
                <div class="stat-change {% if orders_growth > 0 %}positive{% elif orders_growth < 0 %}negative{% else %}neutral{% endif %}">
                    <span class="change-icon">
                        {% if orders_growth > 0 %}‚Üó{% elif orders_growth < 0 %}‚Üò{% else %}‚Üí{% endif %}
                    </span>
                    {% if orders_growth != 0 %}{{ orders_growth }}%{% else %}–°—Ç–∞–±–∏–ª—å–Ω–æ{% endif %} –∑–∞ –º–µ—Å—è—Ü
                </div>
            </div>
        </div>

        <div class="stat-card products">
            <div class="stat-icon">üì¶</div>
            <div class="stat-content">
                <div class="stat-label">–¢–æ–≤–∞—Ä—ã –≤ –∫–∞—Ç–∞–ª–æ–≥–µ</div>
                <div class="stat-value">{{ total_products }}</div>
                <div class="stat-change neutral">
                    <span class="change-icon">üìã</span>
                    –°—Ä–µ–¥–Ω–∏–π —á–µ–∫: {{ avg_order_value|floatformat:0 }} ‚ÇΩ
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
        <!-- Sales Overview -->
        <div class="chart-card sales-overview">
            <div class="chart-header">
                <h3>üìà –û–±–∑–æ—Ä –ø—Ä–æ–¥–∞–∂</h3>
                <p>–ü—Ä–æ–¥–∞–∂–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</p>
                <div class="chart-tabs">
                    <button class="tab-btn active" onclick="switchChart('revenue')">–í—ã—Ä—É—á–∫–∞</button>
                    <button class="tab-btn" onclick="switchChart('orders')">–ó–∞–∫–∞–∑—ã</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="salesChart" width="600" height="300"></canvas>
            </div>
        </div>

        <!-- Sales by Category -->
        <div class="chart-card category-chart">
            <div class="chart-header">
                <h3>üè∑Ô∏è –ü—Ä–æ–¥–∞–∂–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
                <p>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º —Ç–æ–≤–∞—Ä–æ–≤</p>
            </div>
            <div class="chart-container">
                <canvas id="categoryChart" width="300" height="300"></canvas>
            </div>
            <div class="category-legend">
                {% for category in category_stats|slice:":4" %}
                <div class="legend-item">
                    <span class="legend-color" style="background: {% cycle '#4F46E5' '#10B981' '#F59E0B' '#EF4444' %};"></span>
                    <span class="legend-label">{{ category.name }}</span>
                    <span class="legend-value">{{ category.percentage }}%</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Additional Stats Section -->
    <div class="additional-stats">
        <!-- Order Status Stats -->
        <div class="stat-widget">
            <div class="widget-header">
                <h3>üìã –°—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–æ–≤</h3>
                <p>–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤</p>
            </div>
            <div class="status-stats">
                {% for status in order_status_stats %}
                <div class="status-item">
                    <div class="status-info">
                        <span class="status-name">{{ status.status }}</span>
                    </div>
                    <span class="status-count">{{ status.count }}</span>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Top Products -->
        <div class="stat-widget">
            <div class="widget-header">
                <h3>üèÜ –¢–æ–ø —Ç–æ–≤–∞—Ä—ã</h3>
                <p>–°–∞–º—ã–µ –ø—Ä–æ–¥–∞–≤–∞–µ–º—ã–µ —Ç–æ–≤–∞—Ä—ã</p>
            </div>
            <div class="top-products">
                {% for product in top_products %}
                <div class="top-product-item">
                    <div class="product-info">
                        <div class="product-name">{{ product.product__name }}</div>
                        <div class="product-stats">–ü—Ä–æ–¥–∞–Ω–æ: {{ product.total_sold }} —à—Ç. ‚Ä¢ {{ product.total_revenue|floatformat:0 }} ‚ÇΩ</div>
                    </div>
                    <div class="product-rank">{{ forloop.counter }}</div>
                </div>
                {% empty %}
                <div class="empty-state">
                    <p>–ü—Ä–æ–¥–∞–∂ –ø–æ–∫–∞ –Ω–µ—Ç</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Low Stock Products -->
        <div class="stat-widget">
            <div class="widget-header">
                <h3>‚ö†Ô∏è –ù–∏–∑–∫–∏–π –æ—Å—Ç–∞—Ç–æ–∫</h3>
                <p>–¢–æ–≤–∞—Ä—ã —Ç—Ä–µ–±—É—é—â–∏–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è</p>
            </div>
            <div class="low-stock-products">
                {% for product in low_stock_products %}
                <div class="low-stock-item">
                    <div class="product-info">
                        <div class="product-name">{{ product.name }}</div>
                        <div class="stock-warning">–û—Å—Ç–∞–ª–æ—Å—å –º–∞–ª–æ —Ç–æ–≤–∞—Ä–∞!</div>
                    </div>
                    <div class="stock-level">{{ product.stock }}</div>
                </div>
                {% empty %}
                <div class="empty-state">
                    <p>‚úÖ –í—Å–µ —Ç–æ–≤–∞—Ä—ã –≤ –¥–æ—Å—Ç–∞—Ç–∫–µ</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Recent Sales -->
    <div class="recent-sales-card">
        <div class="card-header">
            <h3>üõí –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø—Ä–æ–¥–∞–∂–∏</h3>
            <p>–í—ã —Å–æ–≤–µ—Ä—à–∏–ª–∏ {{ recent_orders_count }} –ø—Ä–æ–¥–∞–∂ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ.</p>
        </div>
        <div class="sales-list">
            {% for order in recent_orders|slice:":5" %}
            <div class="sale-item">
                <div class="customer-info">
                    <div class="customer-avatar">
                        {{ order.first_name.0|default:"?" }}{{ order.last_name.0|default:"" }}
                    </div>
                    <div class="customer-details">
                        <div class="customer-name">{{ order.first_name }} {{ order.last_name }}</div>
                        <div class="customer-email">{{ order.email }}</div>
                    </div>
                </div>
                <div class="sale-amount">+{{ order.total_price }} ‚ÇΩ</div>
            </div>
            {% empty %}
            <div class="empty-sales">
                <p>–ü—Ä–æ–¥–∞–∂ –ø–æ–∫–∞ –Ω–µ—Ç</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
// –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
const salesData = {{ sales_by_day|safe }};
let currentChartType = 'revenue';

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞
function switchChart(type) {
    currentChartType = type;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
    drawSalesChart();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ –ø—Ä–æ–¥–∞–∂
function drawSalesChart() {
    const canvas = document.getElementById('salesChart');
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    ctx.clearRect(0, 0, width, height);
    
    if (!salesData || salesData.length === 0) {
        ctx.fillStyle = '#9CA3AF';
        ctx.font = '16px Inter';
        ctx.textAlign = 'center';
        ctx.fillText('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è', width/2, height/2);
        return;
    }
    
    const data = salesData.map(item => currentChartType === 'revenue' ? item.revenue : item.orders);
    const labels = salesData.map(item => item.date);
    
    const maxValue = Math.max(...data) || 1;
    const padding = 60;
    const chartWidth = width - padding * 2;
    const chartHeight = height - padding * 2;
    const barWidth = chartWidth / data.length * 0.6;
    const barSpacing = chartWidth / data.length * 0.4;
    
    // –†–∏—Å—É–µ–º —Å—Ç–æ–ª–±—Ü—ã
    data.forEach((value, index) => {
        const barHeight = (value / maxValue) * chartHeight;
        const x = padding + index * (barWidth + barSpacing) + barSpacing / 2;
        const y = height - padding - barHeight;
        
        // –ì—Ä–∞–¥–∏–µ–Ω—Ç
        const gradient = ctx.createLinearGradient(0, y, 0, y + barHeight);
        if (currentChartType === 'revenue') {
            gradient.addColorStop(0, '#10B981');
            gradient.addColorStop(1, '#059669');
        } else {
            gradient.addColorStop(0, '#3B82F6');
            gradient.addColorStop(1, '#2563EB');
        }
        
        ctx.fillStyle = gradient;
        ctx.fillRect(x, y, barWidth, barHeight);
        
        // –ü–æ–¥–ø–∏—Å–∏ –¥–∞—Ç
        ctx.fillStyle = '#6B7280';
        ctx.font = '12px Inter';
        ctx.textAlign = 'center';
        ctx.fillText(labels[index], x + barWidth/2, height - 20);
        
        // –ó–Ω–∞—á–µ–Ω–∏—è
        if (value > 0) {
            ctx.fillStyle = '#374151';
            ctx.font = 'bold 12px Inter';
            const displayValue = currentChartType === 'revenue' ? value + '‚ÇΩ' : value;
            ctx.fillText(displayValue, x + barWidth/2, y - 10);
        }
    });
    
    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Å–∏ Y
    ctx.save();
    ctx.translate(20, height/2);
    ctx.rotate(-Math.PI/2);
    ctx.fillStyle = '#6B7280';
    ctx.font = '14px Inter';
    ctx.textAlign = 'center';
    ctx.fillText(currentChartType === 'revenue' ? '–í—ã—Ä—É—á–∫–∞ (‚ÇΩ)' : '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤', 0, 0);
    ctx.restore();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –∫—Ä—É–≥–æ–≤–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π
function drawCategoryChart() {
    const canvas = document.getElementById('categoryChart');
    const ctx = canvas.getContext('2d');
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = 80;
    const innerRadius = 50;
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    const categoryData = [
        {% for category in category_stats|slice:":4" %}
            {{ category.percentage }},
        {% endfor %}
    ];
    
    const colors = ['#4F46E5', '#10B981', '#F59E0B', '#EF4444'];
    const total = categoryData.reduce((a, b) => a + b, 0);
    
    if (total === 0) {
        ctx.fillStyle = '#9CA3AF';
        ctx.font = '16px Inter';
        ctx.textAlign = 'center';
        ctx.fillText('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', centerX, centerY);
        return;
    }
    
    let currentAngle = -Math.PI / 2;
    
    categoryData.forEach((value, index) => {
        const sliceAngle = (value / total) * 2 * Math.PI;
        
        // –†–∏—Å—É–µ–º —Å–µ–≥–º–µ–Ω—Ç
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
        ctx.arc(centerX, centerY, innerRadius, currentAngle + sliceAngle, currentAngle, true);
        ctx.closePath();
        ctx.fillStyle = colors[index] || '#9CA3AF';
        ctx.fill();
        
        currentAngle += sliceAngle;
    });
    
    // –¢–µ–∫—Å—Ç –≤ —Ü–µ–Ω—Ç—Ä–µ
    ctx.fillStyle = '#374151';
    ctx.font = 'bold 24px Inter';
    ctx.textAlign = 'center';
    ctx.fillText('100%', centerX, centerY - 5);
    ctx.font = '12px Inter';
    ctx.fillStyle = '#6B7280';
    ctx.fillText('–ü—Ä–æ–¥–∞–∂–∏', centerX, centerY + 15);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
document.addEventListener('DOMContentLoaded', function() {
    drawSalesChart();
    drawCategoryChart();
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    setInterval(function() {
        fetch('{% url "shop:dashboard_api" %}')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
                    console.log('Dashboard data updated');
                }
            })
            .catch(error => console.error('Error updating dashboard:', error));
    }, 30000);
});
</script>
{% endblock %}
