{% extends base_template|default:'shop/base_dashboard.html' %}

{% block title %}–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ - FashionStore{% endblock %}

{% block content %}
<div class="dashboard-content">
    <!-- Header with controls -->
    <div class="dashboard-header">
        <h1>üìä –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h1>
        <div class="header-actions">
            <select id="periodSelect" class="period-select">
                <option value="7">7 –¥–Ω–µ–π</option>
                <option value="30" selected>30 –¥–Ω–µ–π</option>
                <option value="90">90 –¥–Ω–µ–π</option>
                <option value="365">1 –≥–æ–¥</option>
            </select>
            <button onclick="exportData('orders')" class="btn btn-secondary">
                üìä –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–∫–∞–∑–æ–≤
            </button>
            <button onclick="refreshData()" class="btn btn-primary">
                üîÑ –û–±–Ω–æ–≤–∏—Ç—å
            </button>
        </div>
    </div>

    <!-- Real-time notifications -->
    <div id="notifications" class="notifications-container"></div>

    <!-- Advanced Stats Grid -->
    <div class="advanced-stats-grid">
        <div class="stat-card revenue-card">
            <div class="stat-header">
                <h3>üí∞ –í—ã—Ä—É—á–∫–∞</h3>
                <span class="stat-period" id="revenuePeriod">30 –¥–Ω–µ–π</span>
            </div>
            <div class="stat-value" id="totalRevenue">0 ‚ÇΩ</div>
            <div class="stat-change" id="revenueChange">+0%</div>
            <div class="stat-chart">
                <canvas id="revenueChart" width="200" height="60"></canvas>
            </div>
        </div>

        <div class="stat-card orders-card">
            <div class="stat-header">
                <h3>üõí –ó–∞–∫–∞–∑—ã</h3>
                <span class="stat-period" id="ordersPeriod">30 –¥–Ω–µ–π</span>
            </div>
            <div class="stat-value" id="totalOrders">0</div>
            <div class="stat-change" id="ordersChange">+0%</div>
            <div class="stat-chart">
                <canvas id="ordersChart" width="200" height="60"></canvas>
            </div>
        </div>

        <div class="stat-card customers-card">
            <div class="stat-header">
                <h3>üë• –ü–æ–∫—É–ø–∞—Ç–µ–ª–∏</h3>
                <span class="stat-period">–í—Å–µ–≥–æ</span>
            </div>
            <div class="stat-value" id="totalCustomers">0</div>
            <div class="stat-change" id="customersChange">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
        </div>

        <div class="stat-card avg-order-card">
            <div class="stat-header">
                <h3>üìà –°—Ä–µ–¥–Ω–∏–π —á–µ–∫</h3>
                <span class="stat-period" id="avgOrderPeriod">30 –¥–Ω–µ–π</span>
            </div>
            <div class="stat-value" id="avgOrderValue">0 ‚ÇΩ</div>
            <div class="stat-change" id="avgOrderChange">+0%</div>
        </div>
    </div>

    <!-- Interactive Charts Section -->
    <div class="charts-section">
        <!-- Sales Trend Chart -->
        <div class="chart-card sales-trend">
            <div class="chart-header">
                <h3>üìà –¢—Ä–µ–Ω–¥ –ø—Ä–æ–¥–∞–∂</h3>
                <div class="chart-controls">
                    <button class="chart-btn active" onclick="switchChartType('revenue')">–í—ã—Ä—É—á–∫–∞</button>
                    <button class="chart-btn" onclick="switchChartType('orders')">–ó–∞–∫–∞–∑—ã</button>
                    <button class="chart-btn" onclick="switchChartType('both')">–û–±–∞</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="salesTrendChart" width="800" height="400"></canvas>
            </div>
        </div>

        <!-- Category Performance -->
        <div class="chart-card category-performance">
            <div class="chart-header">
                <h3>üè∑Ô∏è –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–π</h3>
                <p>–ü—Ä–æ–¥–∞–∂–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º —Ç–æ–≤–∞—Ä–æ–≤</p>
            </div>
            <div class="chart-container">
                <canvas id="categoryChart" width="400" height="400"></canvas>
            </div>
            <div class="category-legend" id="categoryLegend"></div>
        </div>
    </div>

    <!-- Top Products Table -->
    <div class="top-products-section">
        <div class="section-header">
            <h3>üèÜ –¢–æ–ø —Ç–æ–≤–∞—Ä—ã</h3>
            <button onclick="exportData('products')" class="btn btn-secondary">
                üìã –≠–∫—Å–ø–æ—Ä—Ç —Ç–æ–≤–∞—Ä–æ–≤
            </button>
        </div>
        <div class="table-container">
            <table class="data-table" id="topProductsTable">
                <thead>
                    <tr>
                        <th>–ü–æ–∑–∏—Ü–∏—è</th>
                        <th>–¢–æ–≤–∞—Ä</th>
                        <th>–ü—Ä–æ–¥–∞–Ω–æ</th>
                        <th>–í—ã—Ä—É—á–∫–∞</th>
                        <th>–¶–µ–Ω–∞</th>
                    </tr>
                </thead>
                <tbody id="topProductsBody">
                    <!-- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Bulk Actions Panel -->
    <div class="bulk-actions-panel" id="bulkActionsPanel" style="display: none;">
        <div class="panel-header">
            <h4>–ú–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h4>
            <button onclick="closeBulkActions()" class="close-btn">√ó</button>
        </div>
        <div class="panel-content">
            <div class="action-group">
                <button onclick="bulkAction('activate')" class="btn btn-success">
                    ‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
                </button>
                <button onclick="bulkAction('deactivate')" class="btn btn-danger">
                    ‚ùå –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
                </button>
            </div>
            <div class="action-group">
                <input type="number" id="stockValue" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" class="form-input">
                <button onclick="bulkUpdateStock()" class="btn btn-primary">
                    üì¶ –û–±–Ω–æ–≤–∏—Ç—å –æ—Å—Ç–∞—Ç–æ–∫
                </button>
            </div>
            <div class="action-group">
                <input type="number" id="priceMultiplier" placeholder="–ú–Ω–æ–∂–∏—Ç–µ–ª—å (1.1 = +10%)" step="0.1" class="form-input">
                <button onclick="bulkUpdatePrice()" class="btn btn-warning">
                    üí∞ –ò–∑–º–µ–Ω–∏—Ç—å —Ü–µ–Ω—ã
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.advanced-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    position: relative;
    overflow: hidden;
}

.stat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.stat-header h3 {
    font-size: 1rem;
    color: #6b7280;
    margin: 0;
}

.stat-period {
    font-size: 0.8rem;
    color: #9ca3af;
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: #111827;
    margin-bottom: 0.5rem;
}

.stat-change {
    font-size: 0.9rem;
    font-weight: 500;
}

.stat-chart {
    margin-top: 1rem;
    height: 60px;
}

.revenue-card {
    border-left: 4px solid #10b981;
}

.orders-card {
    border-left: 4px solid #3b82f6;
}

.customers-card {
    border-left: 4px solid #8b5cf6;
}

.avg-order-card {
    border-left: 4px solid #f59e0b;
}

.charts-section {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.chart-controls {
    display: flex;
    gap: 0.5rem;
}

.chart-btn {
    padding: 0.5rem 1rem;
    border: 1px solid #d1d5db;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
}

.chart-btn.active {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
}

.period-select {
    padding: 0.5rem 1rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    background: white;
}

.notifications-container {
    margin-bottom: 1.5rem;
}

.notification {
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.notification.info {
    background: #dbeafe;
    border-left: 4px solid #3b82f6;
}

.notification.warning {
    background: #fef3c7;
    border-left: 4px solid #f59e0b;
}

.notification.success {
    background: #d1fae5;
    border-left: 4px solid #10b981;
}

.notification.urgent {
    background: #fee2e2;
    border-left: 4px solid #ef4444;
}

.bulk-actions-panel {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    min-width: 400px;
}

.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #e5e7eb;
}

.panel-content {
    padding: 1.5rem;
}

.action-group {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
    align-items: center;
}

.close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #6b7280;
}

@media (max-width: 768px) {
    .charts-section {
        grid-template-columns: 1fr;
    }
    
    .advanced-stats-grid {
        grid-template-columns: 1fr;
    }
    
    .action-group {
        flex-direction: column;
    }
}
</style>

<script>
let currentPeriod = 30;
let currentChartType = 'revenue';
let dashboardData = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    loadNotifications();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    setInterval(loadNotifications, 30000);
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
    document.getElementById('periodSelect').addEventListener('change', function() {
        currentPeriod = parseInt(this.value);
        loadDashboardData();
    });
});

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö dashboard
async function loadDashboardData() {
    try {
        const response = await fetch(`/api/dashboard-stats/?days=${currentPeriod}`);
        const data = await response.json();
        
        if (data.success) {
            dashboardData = data;
            updateStatsCards(data.stats);
            updateCharts(data);
            updateTopProductsTable(data.top_products);
        }
    } catch (error) {
        console.error('Error loading dashboard data:', error);
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function updateStatsCards(stats) {
    document.getElementById('totalRevenue').textContent = 
        new Intl.NumberFormat('ru-RU').format(stats.total_revenue) + ' ‚ÇΩ';
    document.getElementById('totalOrders').textContent = stats.total_orders;
    document.getElementById('totalCustomers').textContent = stats.total_customers;
    document.getElementById('avgOrderValue').textContent = 
        new Intl.NumberFormat('ru-RU').format(stats.avg_order_value) + ' ‚ÇΩ';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–∏–æ–¥—ã
    document.getElementById('revenuePeriod').textContent = `${currentPeriod} –¥–Ω–µ–π`;
    document.getElementById('ordersPeriod').textContent = `${currentPeriod} –¥–Ω–µ–π`;
    document.getElementById('avgOrderPeriod').textContent = `${currentPeriod} –¥–Ω–µ–π`;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤
function updateCharts(data) {
    drawSalesTrendChart(data.daily_sales);
    drawCategoryChart(data.category_stats);
    drawMiniCharts(data.daily_sales);
}

// –†–∏—Å–æ–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ –ø—Ä–æ–¥–∞–∂
function drawSalesTrendChart(salesData) {
    const canvas = document.getElementById('salesTrendChart');
    const ctx = canvas.getContext('2d');
    
    // –û—á–∏—â–∞–µ–º canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (!salesData || salesData.length === 0) return;
    
    const padding = 60;
    const chartWidth = canvas.width - padding * 2;
    const chartHeight = canvas.height - padding * 2;
    
    // –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    let data1, data2, label1, label2, color1, color2;
    
    if (currentChartType === 'revenue') {
        data1 = salesData.map(item => item.revenue);
        label1 = '–í—ã—Ä—É—á–∫–∞ (‚ÇΩ)';
        color1 = '#10b981';
    } else if (currentChartType === 'orders') {
        data1 = salesData.map(item => item.orders);
        label1 = '–ó–∞–∫–∞–∑—ã';
        color1 = '#3b82f6';
    } else { // both
        data1 = salesData.map(item => item.revenue);
        data2 = salesData.map(item => item.orders);
        label1 = '–í—ã—Ä—É—á–∫–∞ (‚ÇΩ)';
        label2 = '–ó–∞–∫–∞–∑—ã';
        color1 = '#10b981';
        color2 = '#3b82f6';
    }
    
    const labels = salesData.map(item => {
        const date = new Date(item.date);
        return date.toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' });
    });
    
    // –†–∏—Å—É–µ–º –ª–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫
    drawLineChart(ctx, {
        data1, data2, labels,
        color1, color2,
        width: chartWidth,
        height: chartHeight,
        padding
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –ª–∏–Ω–µ–π–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞
function drawLineChart(ctx, options) {
    const { data1, data2, labels, color1, color2, width, height, padding } = options;
    
    const maxValue1 = Math.max(...data1) || 1;
    const maxValue2 = data2 ? Math.max(...data2) || 1 : maxValue1;
    
    const stepX = width / (data1.length - 1);
    
    // –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É
    ctx.strokeStyle = '#f3f4f6';
    ctx.lineWidth = 1;
    
    // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
    for (let i = 0; i <= 5; i++) {
        const y = padding + (height / 5) * i;
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(padding + width, y);
        ctx.stroke();
    }
    
    // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
    for (let i = 0; i < data1.length; i++) {
        const x = padding + stepX * i;
        ctx.beginPath();
        ctx.moveTo(x, padding);
        ctx.lineTo(x, padding + height);
        ctx.stroke();
    }
    
    // –†–∏—Å—É–µ–º –ø–µ—Ä–≤—É—é –ª–∏–Ω–∏—é
    ctx.strokeStyle = color1;
    ctx.lineWidth = 3;
    ctx.beginPath();
    
    data1.forEach((value, index) => {
        const x = padding + stepX * index;
        const y = padding + height - (value / maxValue1) * height;
        
        if (index === 0) {
            ctx.moveTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
    });
    
    ctx.stroke();
    
    // –†–∏—Å—É–µ–º –≤—Ç–æ—Ä—É—é –ª–∏–Ω–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å
    if (data2) {
        ctx.strokeStyle = color2;
        ctx.lineWidth = 3;
        ctx.beginPath();
        
        data2.forEach((value, index) => {
            const x = padding + stepX * index;
            const y = padding + height - (value / maxValue2) * height;
            
            if (index === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        });
        
        ctx.stroke();
    }
    
    // –ü–æ–¥–ø–∏—Å–∏ –æ—Å–µ–π
    ctx.fillStyle = '#6b7280';
    ctx.font = '12px Inter';
    ctx.textAlign = 'center';
    
    // –ü–æ–¥–ø–∏—Å–∏ –¥–∞—Ç
    labels.forEach((label, index) => {
        if (index % Math.ceil(labels.length / 7) === 0) { // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é 7-—é –¥–∞—Ç—É
            const x = padding + stepX * index;
            ctx.fillText(label, x, padding + height + 20);
        }
    });
}

// –†–∏—Å–æ–≤–∞–Ω–∏–µ –∫—Ä—É–≥–æ–≤–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π
function drawCategoryChart(categoryData) {
    const canvas = document.getElementById('categoryChart');
    const ctx = canvas.getContext('2d');
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (!categoryData || categoryData.length === 0) return;
    
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = 120;
    
    const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'];
    const total = categoryData.reduce((sum, cat) => sum + cat.revenue, 0);
    
    if (total === 0) return;
    
    let currentAngle = -Math.PI / 2;
    
    // –†–∏—Å—É–µ–º —Å–µ–≥–º–µ–Ω—Ç—ã
    categoryData.forEach((category, index) => {
        const sliceAngle = (category.revenue / total) * 2 * Math.PI;
        
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
        ctx.lineTo(centerX, centerY);
        ctx.closePath();
        
        ctx.fillStyle = colors[index % colors.length];
        ctx.fill();
        
        // –ü–æ–¥–ø–∏—Å–∏
        const labelAngle = currentAngle + sliceAngle / 2;
        const labelX = centerX + Math.cos(labelAngle) * (radius + 30);
        const labelY = centerY + Math.sin(labelAngle) * (radius + 30);
        
        ctx.fillStyle = '#374151';
        ctx.font = '12px Inter';
        ctx.textAlign = 'center';
        
        const percentage = ((category.revenue / total) * 100).toFixed(1);
        if (percentage > 5) { // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∑–Ω–∞—á–∏–º—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã
            ctx.fillText(`${category.name}`, labelX, labelY);
            ctx.fillText(`${percentage}%`, labelX, labelY + 15);
        }
        
        currentAngle += sliceAngle;
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–µ–≥–µ–Ω–¥—É
    updateCategoryLegend(categoryData, colors, total);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–µ–≥–µ–Ω–¥—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π
function updateCategoryLegend(categoryData, colors, total) {
    const legend = document.getElementById('categoryLegend');
    legend.innerHTML = '';
    
    categoryData.forEach((category, index) => {
        const percentage = ((category.revenue / total) * 100).toFixed(1);
        
        const legendItem = document.createElement('div');
        legendItem.className = 'legend-item';
        legendItem.innerHTML = `
            <span class="legend-color" style="background: ${colors[index % colors.length]};"></span>
            <span class="legend-label">${category.name}</span>
            <span class="legend-value">${percentage}%</span>
        `;
        
        legend.appendChild(legendItem);
    });
}

// –†–∏—Å–æ–≤–∞–Ω–∏–µ –º–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫–æ–≤ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö
function drawMiniCharts(salesData) {
    if (!salesData || salesData.length === 0) return;
    
    // –ú–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫ –≤—ã—Ä—É—á–∫–∏
    drawMiniChart('revenueChart', salesData.map(item => item.revenue), '#10b981');
    
    // –ú–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫ –∑–∞–∫–∞–∑–æ–≤
    drawMiniChart('ordersChart', salesData.map(item => item.orders), '#3b82f6');
}

function drawMiniChart(canvasId, data, color) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    const maxValue = Math.max(...data) || 1;
    const stepX = canvas.width / (data.length - 1);
    
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.beginPath();
    
    data.forEach((value, index) => {
        const x = stepX * index;
        const y = canvas.height - (value / maxValue) * canvas.height;
        
        if (index === 0) {
            ctx.moveTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
    });
    
    ctx.stroke();
    
    // –ó–∞–ª–∏–≤–∫–∞ –ø–æ–¥ –ª–∏–Ω–∏–µ–π
    ctx.lineTo(canvas.width, canvas.height);
    ctx.lineTo(0, canvas.height);
    ctx.closePath();
    
    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    gradient.addColorStop(0, color + '40');
    gradient.addColorStop(1, color + '10');
    
    ctx.fillStyle = gradient;
    ctx.fill();
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞
function switchChartType(type) {
    currentChartType = type;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
    document.querySelectorAll('.chart-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
    if (dashboardData) {
        drawSalesTrendChart(dashboardData.daily_sales);
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Ç–æ–ø —Ç–æ–≤–∞—Ä–æ–≤
function updateTopProductsTable(topProducts) {
    const tbody = document.getElementById('topProductsBody');
    tbody.innerHTML = '';
    
    topProducts.forEach((product, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="rank">#${index + 1}</td>
            <td class="product-name">${product.product__name}</td>
            <td class="sold-count">${product.total_sold} —à—Ç.</td>
            <td class="revenue">${new Intl.NumberFormat('ru-RU').format(product.total_revenue)} ‚ÇΩ</td>
            <td class="price">${new Intl.NumberFormat('ru-RU').format(product.product__price)} ‚ÇΩ</td>
        `;
        tbody.appendChild(row);
    });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
async function loadNotifications() {
    try {
        const response = await fetch('/api/notifications/');
        const data = await response.json();
        
        if (data.success) {
            displayNotifications(data.notifications);
        }
    } catch (error) {
        console.error('Error loading notifications:', error);
    }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function displayNotifications(notifications) {
    const container = document.getElementById('notifications');
    container.innerHTML = '';
    
    notifications.forEach(notification => {
        const notificationEl = document.createElement('div');
        notificationEl.className = `notification ${notification.type}`;
        notificationEl.innerHTML = `
            <div class="notification-icon">
                ${getNotificationIcon(notification.type)}
            </div>
            <div class="notification-content">
                <strong>${notification.title}</strong>
                <p>${notification.message}</p>
            </div>
            <div class="notification-count">
                ${notification.count}
            </div>
        `;
        container.appendChild(notificationEl);
    });
}

function getNotificationIcon(type) {
    const icons = {
        info: '‚ÑπÔ∏è',
        warning: '‚ö†Ô∏è',
        success: '‚úÖ',
        urgent: 'üö®'
    };
    return icons[type] || '‚ÑπÔ∏è';
}

// –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
async function exportData(type) {
    try {
        const response = await fetch(`/api/export-data/?type=${type}&format=json`);
        const data = await response.json();
        
        if (data.success) {
            // –°–æ–∑–¥–∞–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
            const blob = new Blob([JSON.stringify(data.data, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${type}_export_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ!', 'success');
        }
    } catch (error) {
        console.error('Error exporting data:', error);
        showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö', 'error');
    }
}

// –ú–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
async function bulkAction(action) {
    const selectedProducts = getSelectedProducts();
    
    if (selectedProducts.length === 0) {
        showMessage('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã –¥–ª—è –¥–µ–π—Å—Ç–≤–∏—è', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/bulk-update-products/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                action: action,
                product_ids: selectedProducts
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showMessage(data.message, 'success');
            closeBulkActions();
            loadDashboardData(); // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
        } else {
            showMessage(data.error, 'error');
        }
    } catch (error) {
        console.error('Error performing bulk action:', error);
        showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –¥–µ–π—Å—Ç–≤–∏—è', 'error');
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤
async function bulkUpdateStock() {
    const stockValue = document.getElementById('stockValue').value;
    
    if (!stockValue) {
        showMessage('–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ', 'warning');
        return;
    }
    
    const selectedProducts = getSelectedProducts();
    
    try {
        const response = await fetch('/api/bulk-update-products/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                action: 'update_stock',
                product_ids: selectedProducts,
                stock_value: parseInt(stockValue)
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showMessage(data.message, 'success');
            closeBulkActions();
            loadDashboardData();
        }
    } catch (error) {
        console.error('Error updating stock:', error);
        showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –æ—Å—Ç–∞—Ç–∫–æ–≤', 'error');
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω
async function bulkUpdatePrice() {
    const priceMultiplier = document.getElementById('priceMultiplier').value;
    
    if (!priceMultiplier) {
        showMessage('–í–≤–µ–¥–∏—Ç–µ –º–Ω–æ–∂–∏—Ç–µ–ª—å —Ü–µ–Ω—ã', 'warning');
        return;
    }
    
    const selectedProducts = getSelectedProducts();
    
    try {
        const response = await fetch('/api/bulk-update-products/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                action: 'update_price',
                product_ids: selectedProducts,
                price_multiplier: parseFloat(priceMultiplier)
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showMessage(data.message, 'success');
            closeBulkActions();
            loadDashboardData();
        }
    } catch (error) {
        console.error('Error updating prices:', error);
        showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ü–µ–Ω', 'error');
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function getSelectedProducts() {
    // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
    // –ü–æ–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
    return [];
}

function closeBulkActions() {
    document.getElementById('bulkActionsPanel').style.display = 'none';
}

function refreshData() {
    loadDashboardData();
    loadNotifications();
    showMessage('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
}

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
}

function showMessage(message, type) {
    // –ü—Ä–æ—Å—Ç–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <p>${message}</p>
        </div>
    `;
    
    document.getElementById('notifications').appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}
</script>
{% endblock %}
